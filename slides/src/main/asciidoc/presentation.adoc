= Kafka: некоторые интересные практики
:revealjs_theme: black
:revealjs_customtheme: theme.css
:revealjs_slideNumber:
:revealjs_history:
:revealjs_progress:
:encoding: UTF-8
:lang: ru
include::_doc_general_attributes.adoc[]
:doctype: article
:toclevels: 3
:imagesdir: images
:source-highlighter: highlightjs
:highlightjsdir: highlight
:icons: font
:iconfont-remote!:
:iconfont-name: font-awesome-4.7.0/css/font-awesome
:revealjs_mouseWheel: true
:revealjs_center: false
:revealjs_transition: none
:revealjs_width: 1600
:revealjs_height: 900

:!figure-caption:

*Алексей Коняев*, akonyaev@croc.ru

[%notitle]
== Истории создания и развития

[cols="50a,50a",frame=none,grid=none]
|===
.^|
[%step]
* 2011 - LinkedIn передал в open-source
* 2014 - Создана компания Confluent
* 2019 - Release 2.4.0
.^|image::kafka_logo.png[]

[big]##Горизонтально-масштабируемая#

[big]##Быстрая#

[big]##Отказоустойчивая#
|===

== Как устроена

[cols="30a,70a",frame=none,grid=none]
|===
|
* Event log
** key
** body
** timestamp
* Topic
** offset
** partitions
** replication-factor
** retention
* Producer & Consumer
* Exactly-once semantics
|image::kafka_anatomy.png[]
|===

== 1 партиция -- 1 группа с 1 потребителем
image::kafka_consumer_0.png[width=40%]

== N партиций -- 1 группа с 1 потребителем
image::kafka_consumer_1.png[width=40%]

== N партиций -- Несколько групп по M потребителей (M &le; N)
image::kafka_consumer_2.png[width=40%]

== N партиций -- 1 группа с M потребителем (M > N)
image::kafka_consumer_3.png[width=40%]

== Очередность получения событий сохраняется
* В рамках партиции
* Для событий с одинаковым ключом

image::kafka_consumer_4.png[width=50%]

== Цифровой рабочий

[cols="30a,70a",frame=none,grid=none]
|===
.^|
* Носимые технологии
* Позиционирование IN/OUT-DOOR
* Работа в режиме реального времени
* Обработка до 1.5М событий в секунду
.^|image::digital_worker.png[]
|===

== Поднимаем в Docker: docker-compose.yaml
[source,yaml]
----
version: '2.4'
services:
  zookeeper:
    image: wurstmeister/zookeeper
    ports:
      - "2181:2181"
  kafka:
    image: wurstmeister/kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_CREATE_TOPICS: >-
        position:1:1,
        distance:1:1,
        speed:1:1,
        acceleration:1:1
----
== Подключаемся из приложения: application.yml
[source,yaml]
----
spring.kafka:
  bootstrap-servers: kafka:9092
----
{nbsp}

Для отладки с локального хоста добавить маппинг
[source,text]
----
c:\Windows\System32\drivers\etc\hosts

127.0.0.1 kafka
----

== Утилиты. Список топиков
[source,bash]
----
$ kafka-topics --zookeeper zookeeper:2181 --list

$ kafkacat -b kafka:9092 -L
----
== Утилиты. Публикация событий
[source,bash]
----
$ kafka-console-producer --broker-list kafka:9092 --topic my_topic \
    --property "parse.key=true" --property "key.separator=\t"  < my_file.txt

$ kafkacat -b kafka:9092 -t my_topic -P -K\t

$ kafkacat -b kafka:9092 -t my_topic -P -K\t -l my_file.txt
----
== Утилиты. Потребление событий
[source,bash]
----
$ kafka-console-consumer --bootstrap-server kafka:9092 --topic my_topic \
    --property print.key=true --property print.value=true

$ kafkacat -b kafka:9092 -t my_topic -C -o end -K\t

$ kafkacat -b kafka:9092 -t my_topic -C -o beginning -c 10
----

== Публикация событий

[source,java]
----
while (true) {}
----

== Потребление событий

== Обработка событий на KafkaStreams

== Интеграция

* Kafka Connect

== Интеграция с Clickhouse

== Интеграция с Esper

== Что в итоге?
[%step]
* Kafka легко принести в свой проект
* Kafka можно использовать
** для взаимодействия модулей
** для потоковой обработки данных
** в Event Sourcing архитектуре
* Есть наработки в проекте "Цифровой рабочий":
https://gitlab.croc.ru/sandbox/AKonyaev/kafka-blocks[gitlab.croc.ru/sandbox/AKonyaev/kafka-blocks]
